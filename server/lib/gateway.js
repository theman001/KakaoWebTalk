const oracledb = require('oracledb');
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

async function initializeDatabase() {
    let connection;
    try {
        const configPath = path.resolve(__dirname, '../../config.yaml');
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));
        const dbConfig = config.database;
        const walletAbsPath = path.resolve(dbConfig.walletPath);

        console.log("=========================================");
        console.log("[DB ì‹¤í–‰] ìµœì¢… ì—°ê²° ì‹œë„");
        console.log(` > WALLET PATH: ${walletAbsPath}`);
        console.log("=========================================");

        connection = await oracledb.getConnection({
            user: dbConfig.user,
            password: dbConfig.password,
            connectString: dbConfig.connectString,
            // Thin ëª¨ë“œ í•„ìˆ˜ ì„¤ì •
            configDir: walletAbsPath,
            walletLocation: walletAbsPath,
            walletPassword: "" // ë¹ˆ ë¬¸ìì—´ì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
        });

        console.log(" ğŸ‰ [DB] Oracle Database ì—°ê²° ëŒ€ì„±ê³µ!");

        // í…Œì´ë¸” ìƒì„± ë¡œì§
        const queries = [
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (SESSION_ID VARCHAR2(100) PRIMARY KEY, AUTH_TOKEN VARCHAR2(500), DEVICE_UUID VARCHAR2(100), LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, SESSION_ID VARCHAR2(100), SENDER_NAME VARCHAR2(100), MESSAGE CLOB, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (const sql of queries) { await connection.execute(sql); }
        
        return connection;

    } catch (err) {
        console.error("\nâŒ [DB ì—ëŸ¬ ë°œìƒ]");
        console.error(`ë©”ì‹œì§€: ${err.message}`);
        // í˜„ì¬ Node ì˜µì…˜ ìƒíƒœ í™•ì¸ ë¡œê·¸ ì¶”ê°€
        console.log(`í˜„ì¬ NODE_OPTIONS: ${process.env.NODE_OPTIONS || 'ì—†ìŒ'}`);
        throw err;
    } finally {
        if (connection) {
            try { await connection.close(); } catch (e) {}
        }
    }
}

module.exports = initializeDatabase;
