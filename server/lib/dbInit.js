const oracledb = require('oracledb');
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

async function initializeDatabase() {
    let connection;
    try {
        // 경로를 index.js 실행 위치 기준으로 절대 경로화
        const configPath = path.resolve(__dirname, '../../config.yaml');
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));

        console.log("[DB] 연결 시도 중...");

        // 초기 코드처럼 복잡한 옵션 없이 연결 시도
        // 단, Thin 모드 호환성을 위해 walletPassword만 빈 값으로 전달
        connection = await oracledb.getConnection({
            user: config.database.user,
            password: config.database.password,
            connectString: config.database.connectString,
            // 아래 줄들을 넣었을 때 에러가 난다면, 시스템이 이미 지갑 위치를 알고 있는 것입니다.
            configDir: path.resolve(config.database.walletPath),
            walletLocation: path.resolve(config.database.walletPath)
        });

        console.log("[DB] Oracle Database 연결 성공.");

        // 테이블 생성 로직 (제공해주신 초기 로직 그대로 유지)
        const queries = [
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (SESSION_ID VARCHAR2(100) PRIMARY KEY, AUTH_TOKEN VARCHAR2(500), DEVICE_UUID VARCHAR2(100), LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, SESSION_ID VARCHAR2(100), SENDER_NAME VARCHAR2(100), MESSAGE CLOB, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (const sql of queries) {
            await connection.execute(sql);
        }

        console.log("[DB] 데이터베이스 초기화 완료.");
        return connection;

    } catch (err) {
        console.error("[DB] 초기화 에러:", err.message);
        throw err;
    } finally {
        if (connection) {
            try { await connection.close(); } catch (err) { console.error(err); }
        }
    }
}

module.exports = initializeDatabase;
