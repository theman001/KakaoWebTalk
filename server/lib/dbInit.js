const oracledb = require('oracledb');
const fs = require('fs');
const yaml = require('js-yaml');
const path = require('path');

async function initializeDatabase() {
    let connection;
    try {
        // 1. 설정 파일 절대 경로 로드
        const configPath = path.resolve(__dirname, '../../config.yaml');
        if (!fs.existsSync(configPath)) {
            throw new Error(`config.yaml 파일을 찾을 수 없습니다: ${configPath}`);
        }
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));

        // 2. Wallet 경로를 절대 경로로 확정
        const walletPath = path.resolve(config.database.walletPath);
        console.log(`[DB] Wallet 위치 시도: ${walletPath}`);

        if (!fs.existsSync(path.join(walletPath, 'tnsnames.ora'))) {
            throw new Error(`Wallet 폴더 내에 tnsnames.ora가 없습니다: ${walletPath}`);
        }

        console.log("[DB] Oracle Thin 모드 접속 시작...");

        // 3. 커넥션 맺기 (Thin 모드 호환성 설정)
        connection = await oracledb.getConnection({
            user: config.database.user,
            password: config.database.password,
            connectString: config.database.connectString,
            // Thin 모드 최신 버전에서 설정을 찾는 위치를 지정합니다.
            configDir: walletPath,
            walletLocation: walletPath
        });

        console.log("[DB] Oracle Database 연결 성공!");

        // 4. 테이블 생성
        const queries = [
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (SESSION_ID VARCHAR2(100) PRIMARY KEY, AUTH_TOKEN VARCHAR2(500), DEVICE_UUID VARCHAR2(100), LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, SESSION_ID VARCHAR2(100), SENDER_NAME VARCHAR2(100), MESSAGE CLOB, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (let sql of queries) {
            await connection.execute(sql);
        }
        console.log("[DB] 테이블 확인 및 초기화 완료.");

    } catch (err) {
        console.error("[DB] 초기화 실패 원인:", err.message);
        throw err; // 상위(index.js)로 에러를 던져서 서버 실행을 중단시킴
    } finally {
        if (connection) {
            try { await connection.close(); } catch (e) {}
        }
    }
}

module.exports = initializeDatabase;
