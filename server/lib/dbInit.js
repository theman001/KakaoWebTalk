const oracledb = require('oracledb');
const fs = require('fs');
const yaml = require('js-yaml');

async function initializeDatabase() {
    let connection;
    try {
        // 설정 로드
        const config = yaml.load(fs.readFileSync('../config.yaml', 'utf8'));

        connection = await oracledb.getConnection({
            user: config.database.user,
            password: config.database.password,
            connectString: config.database.connectString
        });

        console.log("[DB] Oracle Database 연결 성공. 테이블 확인 중...");

        // 1. 세션 테이블 생성
        await connection.execute(`
            BEGIN
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (
                    SESSION_ID VARCHAR2(100) PRIMARY KEY,
                    AUTH_TOKEN VARCHAR2(500),
                    DEVICE_UUID VARCHAR2(100),
                    LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )';
            EXCEPTION
                WHEN OTHERS THEN
                    IF SQLCODE != -955 THEN RAISE; END IF;
            END;
        `);

        // 2. 채팅 로그 테이블 생성
        await connection.execute(`
            BEGIN
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (
                    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    SESSION_ID VARCHAR2(100),
                    SENDER_NAME VARCHAR2(100),
                    MESSAGE CLOB,
                    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )';
            EXCEPTION
                WHEN OTHERS THEN
                    IF SQLCODE != -955 THEN RAISE; END IF;
            END;
        `);

        console.log("[DB] 데이터베이스 초기화 완료.");

    } catch (err) {
        console.error("[DB] 초기화 에러:", err);
        throw err;
    } finally {
        if (connection) {
            try {
                await connection.close();
            } catch (err) {
                console.error(err);
            }
        }
    }
}

module.exports = initializeDatabase;
