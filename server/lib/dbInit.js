const oracledb = require('oracledb');
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

/**
 * 프로젝트 최상단 config.yaml을 참조하여 Oracle Cloud DB(Thin 모드) 초기화
 */
async function initializeDatabase() {
    let connection;
    try {
        // 1. 최상단 config.yaml 경로 설정 (server/lib/ 기준 ../../)
        const configPath = path.resolve(__dirname, '../../config.yaml');
        
        if (!fs.existsSync(configPath)) {
            throw new Error(`설정 파일을 찾을 수 없습니다: ${configPath}`);
        }

        // 2. YAML 파일 파싱
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));
        const dbConfig = config.database; // YAML의 database 섹션 직접 참조

        console.log(`[DB] 설정 로드 완료: ${configPath}`);
        console.log(`[DB] 접속 시도: ${dbConfig.connectString} (Thin Mode)`);

        // 3. Oracle DB 연결 (Thin 모드 설정 적용)
        // walletPassword를 빈 문자열로 주어 SSO 지갑의 복호화 오류를 방지합니다.
        connection = await oracledb.getConnection({
            user: dbConfig.user,
            password: dbConfig.password,
            connectString: dbConfig.connectString,
            configDir: path.resolve(dbConfig.walletPath),
            walletLocation: path.resolve(dbConfig.walletPath),
            walletPassword: "" 
        });

        console.log("[DB] Oracle Autonomous Database 연결 성공!");

        // 4. 필요한 테이블 생성 (이미 있으면 스킵)
        const queries = [
            `BEGIN 
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (
                    SESSION_ID VARCHAR2(100) PRIMARY KEY, 
                    USER_ID VARCHAR2(100),
                    AUTH_TOKEN VARCHAR2(500), 
                    DEVICE_UUID VARCHAR2(100), 
                    REVISION NUMBER DEFAULT 0,
                    LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    IS_VALID CHAR(1) DEFAULT ''Y''
                )'; 
             EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            
            `BEGIN 
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (
                    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
                    CHAT_ID NUMBER,
                    SENDER_ID NUMBER, 
                    MESSAGE CLOB, 
                    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )'; 
             EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (let sql of queries) {
            await connection.execute(sql);
        }
        
        await connection.commit();
        console.log("[DB] 스키마 초기화 및 무결성 확인 완료.");

        // Gateway 등에서 재사용할 수 있도록 connection을 반환하지 않고 
        // 초기화 완료 후 종료합니다. (실제 서비스에서는 Pool을 사용하는 것이 좋으나 현재 구조 유지)
        return connection;

    } catch (err) {
        console.error("[DB] 초기화 실패:");
        console.error(` > 에러 메시지: ${err.message}`);
        
        if (err.message.includes("ORA-12154")) {
            console.error(" > 원인: tnsnames.ora에서 서비스 이름을 찾을 수 없습니다.");
        } else if (err.message.includes("ORA-28759") || err.message.includes("NJS-505")) {
            console.error(" > 원인: Wallet 파일 복호화 실패 또는 경로 오류입니다.");
        }
        
        throw err;
    } finally {
        // 초기화용 커넥션이므로 작업 후 닫아줍니다. 
        // (세션 매니저 등은 필요 시 새로운 커넥션을 맺거나 이 커넥션을 유지하도록 설계 변경 가능)
        if (connection) {
            try {
                await connection.close();
            } catch (e) {
                console.error("[DB] 연결 종료 중 오류:", e.message);
            }
        }
    }
}

module.exports = initializeDatabase;
