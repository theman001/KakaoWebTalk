const oracledb = require('oracledb');
const fs = require('fs');
const yaml = require('js-yaml');
const path = require('path');

async function initializeDatabase() {
    let connection;
    try {
        // 1. 설정 파일 로드
        const configPath = path.join(__dirname, '../../config.yaml');
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));

        console.log("[DB] Oracle Thin 모드 접속 시도 중...");

        // 2. 커넥션 맺기 (walletLocation을 설정하여 Thin 모드 강제)
        connection = await oracledb.getConnection({
            user: config.database.user,
            password: config.database.password,
            connectString: config.database.connectString,
            // Wallet 파일들이 들어있는 절대 경로
            walletLocation: config.database.walletPath 
        });

        console.log("[DB] Oracle Database 연결 성공. 테이블 확인 중...");

        // 3. 테이블 생성 로직
        const tables = [
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (SESSION_ID VARCHAR2(100) PRIMARY KEY, AUTH_TOKEN VARCHAR2(500), DEVICE_UUID VARCHAR2(100), LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            `BEGIN EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, SESSION_ID VARCHAR2(100), SENDER_NAME VARCHAR2(100), MESSAGE CLOB, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP)'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (const sql of tables) {
            await connection.execute(sql);
        }

        console.log("[DB] 데이터베이스 초기화 완료.");

    } catch (err) {
        console.error("[DB] 초기화 에러:", err.message);
        throw err;
    } finally {
        if (connection) {
            try { await connection.close(); } catch (err) { console.error(err); }
        }
    }
}

module.exports = initializeDatabase;
