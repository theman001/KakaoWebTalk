const oracledb = require('oracledb');
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

/**
 * Oracle Database ì´ˆê¸°í™” ë° í…Œì´ë¸” ìƒì„± í•¨ìˆ˜
 */
async function initializeDatabase() {
    let connection;
    try {
        // 1. ì„¤ì • íŒŒì¼ ë¡œë“œ (ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜)
        const configPath = path.resolve(__dirname, '../../config.yaml');
        if (!fs.existsSync(configPath)) {
            throw new Error(`ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${configPath}`);
        }
        
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));
        const dbConfig = config.database;
        const walletAbsPath = path.resolve(dbConfig.walletPath);

        // 2. [ë””ë²„ê¹…] ì ‘ì† ì •ë³´ ìƒì„¸ ì¶œë ¥ (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
        console.log("=========================================");
        console.log("[DB ì „ì²´ ë””ë²„ê·¸] ì ‘ì† ì„¤ì • ìƒì„¸ ë‚´ì—­");
        console.log(` > USER      : ${dbConfig.user}`);
        console.log(` > PASSWORD  : ${dbConfig.password}`);
        console.log(` > TNS_NAME  : ${dbConfig.connectString}`);
        console.log(` > WALLET    : ${walletAbsPath}`);
        console.log("=========================================");

        // 3. Oracle Connection ì‹œë„
        // Thin ëª¨ë“œì—ì„œ bad decrypt ë°œìƒ ì‹œ walletPasswordë¥¼ ë¹ˆ ê°’ìœ¼ë¡œ ì£¼ê±°ë‚˜ ì•„ì˜ˆ ìƒëµí•˜ì—¬ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
        connection = await oracledb.getConnection({
            user: dbConfig.user,
            password: dbConfig.password,
            connectString: dbConfig.connectString,
            configDir: walletAbsPath,    // tnsnames.ora, sqlnet.ora ìœ„ì¹˜
            walletLocation: walletAbsPath // cwallet.sso ìœ„ì¹˜
            // walletPassword: "" // í•„ìš” ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ í…ŒìŠ¤íŠ¸
        });

        console.log("[DB] Oracle Database ì—°ê²° ì„±ê³µ! í…Œì´ë¸” ì ê²€ì„ ì‹œì‘í•©ë‹ˆë‹¤.");

        // 4. í…Œì´ë¸” ìƒì„± (ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìƒì„±)
        // ì„¸ì…˜ ê´€ë¦¬ í…Œì´ë¸”
        await connection.execute(`
            BEGIN
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (
                    SESSION_ID VARCHAR2(100) PRIMARY KEY,
                    AUTH_TOKEN VARCHAR2(500),
                    DEVICE_UUID VARCHAR2(100),
                    LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )';
            EXCEPTION
                WHEN OTHERS THEN
                    IF SQLCODE != -955 THEN RAISE; END IF;
            END;
        `);

        // ì±„íŒ… ë¡œê·¸ í…Œì´ë¸”
        await connection.execute(`
            BEGIN
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (
                    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    SESSION_ID VARCHAR2(100),
                    SENDER_NAME VARCHAR2(100),
                    MESSAGE CLOB,
                    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )';
            EXCEPTION
                WHEN OTHERS THEN
                    IF SQLCODE != -955 THEN RAISE; END IF;
            END;
        `);

        console.log("[DB] ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ.");
        return connection;

    } catch (err) {
        console.error("\n[DB ì ‘ì† ë° ì´ˆê¸°í™” ì—ëŸ¬]");
        console.error(` > ì—ëŸ¬ ì½”ë“œ: ${err.code || 'N/A'}`);
        console.error(` > ì—ëŸ¬ ë‚´ìš©: ${err.message}`);
        
        if (err.message.includes("bad decrypt")) {
            console.error(" > ğŸ’¡ ì›ì¸ ë¶„ì„: Node.jsì˜ OpenSSL ë²„ì „ í˜¸í™˜ì„± ë¬¸ì œ ë˜ëŠ” ì§€ê°‘ íŒŒì¼ ì†ìƒì…ë‹ˆë‹¤.");
            console.error(" > ğŸ’¡ í•´ê²° ì‹œë„: ì„œë¹„ìŠ¤ íŒŒì¼ì— openssl-legacy-provider ì˜µì…˜ì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }
        throw err;
    } finally {
        if (connection) {
            try {
                await connection.close();
            } catch (closeErr) {
                console.error("[DB] ì—°ê²° ë‹«ê¸° ì‹¤íŒ¨:", closeErr);
            }
        }
    }
}

module.exports = initializeDatabase;
