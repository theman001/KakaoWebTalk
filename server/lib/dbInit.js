const oracledb = require('oracledb');
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

async function initializeDatabase() {
    let connection;
    try {
        // 1. 설정 파일 로드
        const configPath = path.resolve(__dirname, '../../config.yaml');
        const config = yaml.load(fs.readFileSync(configPath, 'utf8'));

        // 2. Wallet 및 TNS 경로 설정 (절대 경로 확정)
        const walletPath = path.resolve(config.database.walletPath);
        
        // Thin 모드 필수 설정: tnsnames.ora가 있는 디렉토리를 configDir로 지정
        // 별도의 라이브러리 설치 없이 이 경로의 설정파일을 읽습니다.
        if (!fs.existsSync(path.join(walletPath, 'tnsnames.ora'))) {
            throw new Error(`Wallet 경로에 tnsnames.ora가 없습니다: ${walletPath}`);
        }

        console.log(`[DB] Thin 모드 접속 시도... (Wallet: ${walletPath})`);

        // 3. Oracle DB 연결
        connection = await oracledb.getConnection({
            user: config.database.user,
            password: config.database.password,
            connectString: config.database.connectString, // e.g., "kakaowebdb_high"
            configDir: walletPath, // tnsnames.ora 위치
            walletLocation: walletPath // cwallet.sso 위치
        });

        console.log("[DB] Oracle Database 연결 성공!");

        // 4. 테이블 초기화 (스키마 생성)
        const queries = [
            `BEGIN 
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_SESSIONS (
                    SESSION_ID VARCHAR2(100) PRIMARY KEY, 
                    USER_ID VARCHAR2(100),
                    AUTH_TOKEN VARCHAR2(500), 
                    DEVICE_UUID VARCHAR2(100), 
                    REVISION NUMBER DEFAULT 0,
                    LAST_LOGIN TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    IS_VALID CHAR(1) DEFAULT ''Y''
                )'; 
             EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`,
            
            `BEGIN 
                EXECUTE IMMEDIATE 'CREATE TABLE KAKAOWEB_CHAT_LOGS (
                    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
                    CHAT_ID NUMBER,
                    SENDER_ID NUMBER, 
                    MESSAGE CLOB, 
                    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )'; 
             EXCEPTION WHEN OTHERS THEN IF SQLCODE != -955 THEN RAISE; END IF; END;`
        ];

        for (let sql of queries) {
            await connection.execute(sql);
        }
        await connection.commit();
        console.log("[DB] 스키마 확인 및 초기화 완료.");

    } catch (err) {
        console.error("[DB] 초기화 실패:", err.message);
        throw err;
    } finally {
        if (connection) {
            try { await connection.close(); } catch (e) {}
        }
    }
}

module.exports = initializeDatabase;
